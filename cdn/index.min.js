var PIECE_CHARS={pawn:{W:"♙",B:"♟"},rook:{W:"♖",B:"♜"},knight:{W:"♘",B:"♞"},bishop:{W:"♗",B:"♝"},queen:{W:"♕",B:"♛"},king:{W:"♔",B:"♚"}};function Piece(e,o,t,i,r,n){if(t&&(this.char=t[i]),this.color=i,this.x=e,this.y=o,this.game=r,this.type=n,n){var a="knight"===n?"n":n.charAt(0);"W"===this.color&&(a=a.toUpperCase()),this.FENname=a}}function Pawn(e,o,t,i){Piece.call(this,e,o,PIECE_CHARS.pawn,t,i,"pawn")}function Rook(e,o,t,i){Piece.call(this,e,o,PIECE_CHARS.rook,t,i,"rook")}function Knight(e,o,t,i){Piece.call(this,e,o,PIECE_CHARS.knight,t,i,"knight")}function Bishop(e,o,t,i){Piece.call(this,e,o,PIECE_CHARS.bishop,t,i,"bishop")}function Queen(e,o,t,i){Piece.call(this,e,o,PIECE_CHARS.queen,t,i,"queen")}function King(e,o,t,i){Piece.call(this,e,o,PIECE_CHARS.king,t,i,"king")}function Game(e){this.board=[];for(var o=0;o<8;o++){for(var t=[],i=0;i<8;i++)t.push(null);this.board.push(t)}this.turn=[],this.FEN=[],this.FENboard=[],this.threefold=[]}Piece.empty=function(){return new Piece},Piece.prototype.getValidMoves=function(){return[{x:0,y:0},{x:7,y:7}]},Pawn.prototype=Piece.empty(),Pawn.prototype.getValidMoves=function(e){var o,t,i=this.game,r=[],n=this.y,a=this.x,c=i.board,h=i.turn,s=h.length,p="W"===this.color?n-1:n+1,u="W"===this.color?n-2:n+2,l=(this.color,[a-1,a+1]);p<8&&p>=0&&!c[p][a]&&(r.push({x:a,y:p}),(1===n||6===n)&&u<8&&u>=0&&!i.board[u][a]&&r.push({x:a,y:u}));for(var f=0;f<2;f++)t=l[f],p<8&&p>=0&&c[p][t]&&c[p][t].color!==this.color&&r.push({x:t,y:p});for(f=0;f<2;f++)t=l[f],!(o=h[s-1])||"pawn"!==o.type||o.to.x!==t||o.to.y!==n||o.color===this.color||1!==o.from.y&&6!==o.from.y||3!==n&&4!==n||r.push({x:t,y:p,movePiece:{piece:i.board[n][t],from:{x:t,y:n},to:null}});return e?i.simulateAndFilter(r,this):r},Piece.pawn=function(e,o,t,i){return new Pawn(e,o,t,i)},Rook.prototype=Piece.empty(),Rook.prototype.getValidMoves=function(e){var o=this.game,t=[];[[-1,0],[1,0],[0,1],[0,-1]].forEach(function(e){var i,r,n,a;for(i=1;(r=this.x+e[0]*i,!((n=this.y+e[1]*i)<0||n>7||r<0||r>7))&&(!(a=o.board[n][r])||a.color!==this.color)&&(t.push({x:r,y:n}),!a);i++);},this);return e?o.simulateAndFilter(t,this):t},Piece.rook=function(e,o,t,i){return new Rook(e,o,t,i)},Knight.prototype=Piece.empty(),Knight.prototype.getValidMoves=function(e){for(var o,t,i=this.game,r=[],n=[[2,1],[-2,1],[1,2],[-1,2],[2,-1],[-2,-1],[1,-2],[-1,-2]],a=0;a<n.length;a++){var c,h=!1;o=n[a][0],t=n[a][1],this.x+o<8&&this.x+o>=0&&this.y+t<8&&this.y+t>=0&&(h=!(c=i.board[this.y+t][this.x+o])||c.color!==this.color),h&&r.push({x:this.x+o,y:this.y+t})}return e?i.simulateAndFilter(r,this):r},Piece.knight=function(e,o,t,i){return new Knight(e,o,t,i)},Bishop.prototype=Piece.empty(),Bishop.prototype.getValidMoves=function(e){var o=this.game,t=[];[[-1,-1],[1,1],[-1,1],[1,-1]].forEach(function(e){var i,r,n,a;for(i=1;(r=this.x+e[0]*i,!((n=this.y+e[1]*i)<0||n>7||r<0||r>7))&&(!(a=o.board[n][r])||a.color!==this.color)&&(t.push({x:r,y:n}),!a);i++);},this);return e?o.simulateAndFilter(t,this):t},Piece.bishop=function(e,o,t,i){return new Bishop(e,o,t,i)},Queen.prototype=Piece.empty(),Queen.prototype.getValidMoves=function(e){var o=this.game,t=Rook.prototype.getValidMoves.call(this),i=Bishop.prototype.getValidMoves.call(this),r=t.concat(i);return e?o.simulateAndFilter(r,this):r},Piece.queen=function(e,o,t,i){return new Queen(e,o,t,i)},King.prototype=Piece.empty(),King.prototype.getValidMoves=function(e){var o=[],t=this.x,i=this.y,r=this.game,n=r.turn,a=this;[[0,1],[0,-1],[1,1],[-1,-1],[1,-1],[-1,1],[-1,0],[1,0]].forEach(function(e){var n,c=t+e[0],h=i+e[1];c<8&&c>=0&&h<8&&h>=0&&((n=r.board[h][c])&&n.color===a.color||o.push({x:c,y:h}))}),n.some(function(e){return"king"===e.type&&e.color===a.color})||[[0,2,-1],[7,6,1]].forEach(function(e){var c=e[0],h=e[1],s=e[2],p=r.board[i][c];if(p&&"rook"!==!p.type&&!n.some(function(e){return e.from.x===c&&e.from.y===i})){for(var u=t+s;u!==c;u+=s){if(r.board[i][u])return;var l=!0;if(r.board.forEach(function(e){e.forEach(function(e){e&&"king"!==e.type&&e.color!==a.color&&e.getValidMoves().forEach(function(e){e&&e.y===i&&e.x===u&&(l=!1)})})}),!l)return}var f={x:h,y:i,movePiece:{piece:a.game.board[i][c],from:{x:c,y:i},to:{y:i,x:t+s}}};o.push(f)}});return e?r.simulateAndFilter(o,a):o},Piece.king=function(e,o,t,i){return new King(e,o,t,i)},Game.prototype.piece=function(e,o,t,i){var r=Piece[e](o,t,i,this);this.board[t][o]=r,this.FEN=this.gameToFEN(),this.FENboard=this.boardToFEN()},Game.prototype.moveSelected=function(e,o,t,i,r,n,a){var c=o.x,h=o.y;if(e){var s={x:e.x,y:e.y};if(this.board[h][c]!==e){for(var p=e.getValidMoves(!a),u=null,l=0;l<p.length;l++){var f=p[l];if(f.x===c&&f.y===h){u=f;break}}if(!u)return!1;var y,m,v,g=u.movePiece;g&&(y=g.from,null===(m=g.to)?this.board[y.y][y.x]=null:(v=this.board[y.y][y.x],this.board[m.y][m.x]=v,v.x=m.x,v.y=m.y,this.board[y.y][y.x]=null));var d=this.board[h][c]?this.board[h][c]:null;g=g?u.movePiece:null,this.turn.push({from:s,to:o,color:e.color,type:e.type,piece:d,movePiece:g}),this.board[h][c]=e,this.board[e.y][e.x]=null,this.board[h][c].x=c,this.board[h][c].y=h,this.FEN=this.gameToFEN(),this.FENboard=this.boardToFEN(),this.threefold.push(this.FENboard),("pawn"===e.type||d)&&(this.threefold=[]),this.threefoldCheck()&&i("D"),this.halfmoveClock()>=50&&i("D"),"pawn"===e.type&&("W"===e.color&&0===h||"B"===e.color&&7===h)&&t&&(r||"B"!==e.color?t(e,c,h,e.color):this.promotePawn(e,c,h,e.color,"queen"));var x="W"===e.color?"B":"W",P=this.checkmate(x);if(P&&i(P),r){var b=ChessAI(this);this.moveSelected(this.board[b.from.y][b.from.x],b.to,t,i,!1,!0,a)}}return e=null,!0}},Game.prototype.promotePawn=function(e,o,t,i,r){this.piece(r,o,t,i)},Game.prototype.simulateAndFilter=function(e,o){var t=[],i=this,r=this.board;return e.forEach(function(e,n){var a=e.y,c=e.x,h={x:o.x,y:o.y},s=r[a][c]?{piece:r[a][c],from:{x:c,y:a},to:null}:null;e.movePiece&&(s=e.movePiece),s&&i.simpleMovePiece(s.piece,s.from,s.to),i.simpleMovePiece(o,h,{x:c,y:a});var p=i.warning(o.color);i.simpleMovePiece(o,{x:c,y:a},h),s&&i.simpleMovePiece(s.piece,s.to,s.from),p||t.push(e)}),t},Game.prototype.checkmate=function(e){for(var o=0;o<8;o++)for(var t=0;t<8;t++)if(this.board[o][t]&&this.board[o][t].color===e&&this.board[o][t].getValidMoves(!0).length)return!1;return this.warning(e)?e:"D"},Game.prototype.simpleMovePiece=function(e,o,t){var i=this.board;t&&(i[t.y][t.x]=e,e.x=t.x,e.y=t.y),o&&(i[o.y][o.x]=null)},Game.prototype.simpleMove=function(e){var o=this,t=o.board,i=e.from,r=e.to,n=t[i.y][i.x],a=this.board[r.y][r.x]?this.board[r.y][r.x]:null,c=t[r.y][r.x]?{piece:t[r.y][r.x],from:{x:r.x,y:r.y},to:null}:null;return this.turn.push({from:i,to:{x:r.x,y:r.y},color:e.color,type:n.type,piece:a,movePiece:c}),r.movePiece&&(c=r.movePiece),c&&o.simpleMovePiece(c.piece,c.from,c.to),o.simpleMovePiece(n,i,{x:r.x,y:r.y}),function(){c&&o.simpleMovePiece(c.piece,c.to,c.from),o.simpleMovePiece(n,{x:r.x,y:r.y},i),a&&(t[r.y][r.x]=a),o.turn.pop()}},Game.prototype.warning=function(e){var o,t=!1;return this.board.forEach(function(t){t.forEach(function(t){t&&t.color===e&&"king"===t.type&&(o=t)})}),this.board.forEach(function(i){i.forEach(function(i){i&&i.color!==e&&i.getValidMoves().forEach(function(e){e.x===o.x&&e.y===o.y&&(t=!0)})})}),t},Game.prototype.threefoldCheck=function(){for(var e=this.threefold,o=e.length,t=0;t<o;t++){for(var i=0,r=t+1;r<o;r++)e[t]===e[r]&&(i+=1);if(i>=2)return!0}return!1},Game.prototype.pieceToAN=function(e,o){return"abcdefgh".charAt(e)+(8-o)},Game.prototype.boardToFEN=function(){for(var e=this.board,o="",t=0,i=0;i<8;i++){for(var r=0;r<8;r++)e[i][r]?(t&&(o+=t),t=0,o+=e[i][r].FENname):t++;t&&(o+=t),t=0,o+=i<7?"/":""}return o},Game.prototype.halfmoveClock=function(){var e=this.turn,o=e.length,t=0;if(0===e.length)return t;for(var i=e[o-1-t];t<=o-1&&"pawn"!==i.type&&!i.piece;)i=e[o-1-++t];return t},Game.prototype.activeColour=function(){var e=this.turn;return e.length&&"W"===e[e.length-1].color?"b":"w"},Game.prototype.castlingTarget=function(){var e,o,t=this.board,i=this.turn,r="";return i.forEach(function(t){e="king"===t.type&&"W"===t.color,o="king"===t.type&&"B"===t.color}),[[7,0],[0,0],[7,7],[0,7]].forEach(function(n){var a=n[0],c=n[1],h=t[c][a];if((7!==c||!e)&&(0!==c||!o)&&h&&"rook"!==!h.type&&!i.some(function(e){return"rook"===e.type&&(e.from.x===a&&e.from.y===c)})){var s=0===a?"q":"k";r+=0===c?s.toUpperCase():s}}),r||(r="-"),r},Game.prototype.enPassantTarget=function(){var e=this.turn,o="";if(e.length){var t=e[e.length-1];"W"===t.color&&4===t.to.y&&(o=this.pieceToAN(t.to.x,t.to.y+1)),"B"===t.color&&3===t.to.y&&(o=this.pieceToAN(t.to.x,t.to.y-1))}return o||(o="-"),o},Game.prototype.fullmoveCount=function(){var e=1;return this.turn.forEach(function(o){"B"===o.color&&(e+=1)}),e},Game.prototype.gameToFEN=function(){var e="";return e+=this.boardToFEN(),e+=" "+this.activeColour(),e+=" "+this.castlingTarget(),e+=" "+this.enPassantTarget(),e+=" "+this.halfmoveClock(),e+=" "+this.fullmoveCount()},Game.prototype.initializeGame=function(){for(var e=new Game,o=0;o<8;o++)e.piece("pawn",o,6,"W"),e.piece("pawn",o,1,"B");return e.piece("rook",0,0,"B"),e.piece("knight",1,0,"B"),e.piece("bishop",2,0,"B"),e.piece("queen",3,0,"B"),e.piece("king",4,0,"B"),e.piece("bishop",5,0,"B"),e.piece("knight",6,0,"B"),e.piece("rook",7,0,"B"),e.piece("rook",0,7,"W"),e.piece("knight",1,7,"W"),e.piece("bishop",2,7,"W"),e.piece("queen",3,7,"W"),e.piece("king",4,7,"W"),e.piece("bishop",5,7,"W"),e.piece("knight",6,7,"W"),e.piece("rook",7,7,"W"),e},Game.prototype.allMoves=function(){for(var e=this.board,o=[],t=this.activeColour().toUpperCase(),i=0;i<8;i++)for(var r=0;r<8;r++){if(e[i][r]&&e[i][r].color===t)e[i][r].getValidMoves().forEach(function(t){o.push({color:e[i][r].color,from:{x:r,y:i},to:t,FENname:e[i][r].FENname})})}return o};var ChessAI=function(e,o,t){for(var i,r=o.allMoves(),n=-9999,a=0;a<r.length;a++){var c=r[a],h=o.simpleMove(c),s=minimax(e-1,o,-1e4,1e4,!t);h(),s>=n&&(n=s,i=c)}return i},minimax=function(e,o,t,i,r){if(0===e)return-evaluateBoard(o.board);var n=o.allMoves();if(r){for(var a=-9999,c=0;c<n.length;c++){var h=o.simpleMove(n[c]);if(a=Math.max(a,minimax(e-1,o,t,i,!r)),h(),i<=(t=Math.max(t,a)))return a}return a}for(a=9999,c=0;c<n.length;c++){h=o.simpleMove(n[c]);if(a=Math.min(a,minimax(e-1,o,t,i,!r)),h(),(i=Math.min(i,a))<=t)return a}return a},evaluateBoard=function(e){for(var o=0,t=0;t<8;t++)for(var i=0;i<8;i++)o+=getPieceValue(e[t][i]);return o},getPieceValue=function(e){if(null===e)return 0;var o,t=(o=e,e.color,"pawn"===o.type?10:"rook"===o.type?50:"knight"===o.type?30:"bishop"===o.type?30:"queen"===o.type?90:"king"===o.type?900:void 0);return"W"===e.color?t:-t};window.RSGChess={Game:Game,AI:ChessAI,Pieces:{PIECE_CHARS:PIECE_CHARS,pawn:Piece.pawn,rook:Piece.rook,knight:Piece.knight,bishop:Piece.bishop,queen:Piece.queen,king:Piece.king}};